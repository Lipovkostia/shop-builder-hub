
# План: Видеотрансляция и чат для оптового магазина

## Обновлённый layout

```text
┌─────────────────────────────────────────────────────────────────────┐
│                          ШАПКА МАГАЗИНА                              │
│   [Лого] [Поиск...                           ] [Корзина]            │
├─────────────────────────────────────────────────────────────────────┤
│                              │                                       │
│   ЛЕВАЯ КОЛОНКА (w-80)       │        ТОВАРЫ (flex-1)               │
│   ──────────────────────     │        ─────────────────────         │
│   ┌───────────────────────┐  │        ┌─────────────────────────┐   │
│   │                       │  │        │ Товар | Цена | Ед | [+] │   │
│   │   🎥 ВИДЕО-ПЛЕЕР      │  │        ├─────────────────────────┤   │
│   │      (16:9 HLS)       │  │        │ Хамон Иберико           │   │
│   │                       │  │        │ 12 500 ₽/кг      [+]    │   │
│   └───────────────────────┘  │        ├─────────────────────────┤   │
│   📌 Заголовок эфира         │        │ Сыр Манчего             │   │
│                              │        │ 8 200 ₽/кг       [+]    │   │
│   ┌───────────────────────┐  │        ├─────────────────────────┤   │
│   │ 💬 Чат    ● 5 зрителей│  │        │ Оливки Каламата         │   │
│   ├───────────────────────┤  │        │ 1 450 ₽/кг       [+]    │   │
│   │ Гость: Какой срок?    │  │        └─────────────────────────┘   │
│   │ 🛒 Продавец: 12 мес   │  │                                       │
│   │ Гость: Отлично!       │  │                                       │
│   ├───────────────────────┤  │                                       │
│   │ [Сообщение...   ] [▶] │  │                                       │
│   └───────────────────────┘  │                                       │
│                              │                                       │
│   КАТЕГОРИИ                  │                                       │
│   ──────────────────────     │                                       │
│   ● Все товары          125  │                                       │
│     Хамон                45  │                                       │
│     Сыры                 38  │                                       │
│     Оливки               22  │                                       │
│                              │                                       │
│   КОНТАКТЫ                   │                                       │
│   📞 +7 900 123-45-67        │                                       │
│   ✉️ info@example.com        │                                       │
│                              │                                       │
└──────────────────────────────┴───────────────────────────────────────┘
```

---

## Часть 1: База данных

### Новые поля в таблице `stores`

| Поле | Тип | Описание |
|------|-----|----------|
| `wholesale_livestream_enabled` | BOOLEAN | Включение блока трансляции |
| `wholesale_livestream_url` | TEXT | URL HLS-потока (.m3u8) |
| `wholesale_livestream_title` | TEXT | Заголовок текущего эфира |

### Новая таблица `livestream_chat_messages`

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID | Первичный ключ |
| `store_id` | UUID | Ссылка на магазин |
| `sender_name` | TEXT | Имя отправителя |
| `message` | TEXT | Текст сообщения |
| `is_seller` | BOOLEAN | Флаг сообщения от продавца |
| `created_at` | TIMESTAMPTZ | Время отправки |

Включение Realtime и публичные RLS-политики для чтения/записи.

---

## Часть 2: Новые компоненты

### 1. `WholesaleLivestreamPlayer.tsx`

HLS видеоплеер с использованием `hls.js`:
- Соотношение сторон 16:9
- Индикатор "LIVE" при активном эфире
- Fallback-заглушка когда поток недоступен
- Автоплей без звука (muted)

### 2. `WholesaleLivestreamChat.tsx`

Компактный чат для посетителей:
- Высота ограничена (max-h-64) с прокруткой
- Автопрокрутка к новым сообщениям
- Поле ввода имени гостя (сохраняется в localStorage)
- Realtime-подписка на новые сообщения
- Счётчик онлайн-зрителей через Supabase Presence
- Сообщения продавца выделены визуально

### 3. `WholesaleLivestreamBlock.tsx`

Обёртка для размещения в сайдбаре:
- Видео сверху
- Заголовок эфира под видео
- Чат под заголовком
- Компактные отступы для сайдбара

---

## Часть 3: Изменения в WholesaleStore.tsx

### Новый layout сайдбара

```text
<aside className="hidden lg:block w-80 shrink-0">
  <div className="sticky top-24 space-y-4">
    
    {/* 1. Блок трансляции (если включён) */}
    {store.wholesale_livestream_enabled && (
      <WholesaleLivestreamBlock
        storeId={store.id}
        streamUrl={store.wholesale_livestream_url}
        streamTitle={store.wholesale_livestream_title}
      />
    )}
    
    {/* 2. Категории */}
    <div>
      <h2>Категории</h2>
      <nav>...</nav>
    </div>
    
    {/* 3. Контакты */}
    <div>...</div>
    
  </div>
</aside>
```

Ширина сайдбара увеличена с `w-64` до `w-80` для размещения видео.

---

## Часть 4: Настройки в админке

### Новая секция в `WholesaleSettingsSection.tsx`

Добавить карточку "Прямые трансляции":

- Переключатель включения блока
- Поле для URL HLS-потока
- Поле для заголовка эфира
- Инструкция по настройке OBS/стриминга
- Кнопка сохранения

---

## Часть 5: Хук `useLivestreamChat.ts`

Функционал:
- `messages` — список последних 50 сообщений
- `sendMessage(name, text)` — отправка сообщения
- `viewersCount` — количество онлайн-зрителей
- Realtime-подписка на INSERT в таблицу чата
- Presence-канал для отслеживания зрителей

---

## Зависимости

Необходимо добавить библиотеку `hls.js` для воспроизведения HLS-потоков:

```
hls.js
```

---

## Файлы для создания/изменения

| Файл | Действие |
|------|----------|
| Миграция БД | Создать: поля в stores + таблица чата |
| `src/hooks/useLivestreamChat.ts` | Создать |
| `src/components/wholesale/WholesaleLivestreamPlayer.tsx` | Создать |
| `src/components/wholesale/WholesaleLivestreamChat.tsx` | Создать |
| `src/components/wholesale/WholesaleLivestreamBlock.tsx` | Создать |
| `src/pages/WholesaleStore.tsx` | Изменить: обновить layout сайдбара |
| `src/components/admin/WholesaleSettingsSection.tsx` | Изменить: добавить настройки стриминга |
| `src/hooks/useWholesaleStore.ts` | Изменить: добавить поля стриминга |

---

## Мобильная адаптация

На мобильных устройствах (где сайдбар скрыт):
- Блок трансляции показывается над списком товаров
- Чат сворачивается в компактную кнопку для раскрытия
- Видео адаптируется по ширине экрана
