
# План оптимизации производительности ассортимента (300+ товаров)

## Проблема
Когда в ассортименте более 300 товаров, страница начинает тормозить при:
- Добавлении нового товара
- Добавлении/редактировании фото
- Любых изменениях в таблице

## Причины проблемы

1. **Все товары рендерятся сразу** — при 600+ товарах создается 600+ строк таблицы, каждая содержит множество интерактивных элементов (инпуты, селекты, кнопки).

2. **Каждое изменение вызывает re-render всего списка** — когда обновляется один товар, React пересчитывает всю таблицу.

3. **Огромный компонент AdminPanel** — файл содержит почти 7000 строк кода с множеством state-переменных, любое изменение которых перерисовывает все.

4. **Отсутствие виртуализации** — таблица не использует "windowing" (отрисовку только видимых строк).

## Решение: 5-этапная оптимизация

### Этап 1: Виртуализация таблицы товаров
**Самое важное изменение** — рендерить только видимые строки (~20-30 вместо 600+).

Что будет сделано:
- Добавить библиотеку `@tanstack/react-virtual` (уже зарекомендовала себя для таких задач)
- Обернуть таблицу товаров в виртуализированный контейнер
- Рендерить только строки в viewport + небольшой буфер сверху/снизу

Результат: вместо 600+ DOM-узлов для строк будет ~30, что ускорит первоначальную отрисовку и все обновления на порядок.

### Этап 2: Мемоизация строк таблицы
Предотвратить ненужный re-render строк при изменении других товаров.

Что будет сделано:
- Вынести логику рендеринга строки в отдельный мемоизированный компонент `ProductTableRow`
- Использовать `React.memo` с корректным сравнением props
- Стабилизировать callback-функции через `useCallback`

Результат: при изменении одного товара будет перерисована только его строка.

### Этап 3: Оптимизация загрузки изображений
Ускорить процесс добавления фото.

Что будет сделано:
- Показывать локальный превью изображения мгновенно (через `URL.createObjectURL`) до завершения загрузки на сервер
- Загружать изображения в фоне с индикатором прогресса
- Добавить оптимистичное обновление UI — картинка появляется сразу, а загрузка идет параллельно

Результат: пользователь видит результат мгновенно, не ожидая загрузки.

### Этап 4: Debounce для инлайн-редактирования
Уменьшить частоту запросов к базе при редактировании.

Что будет сделано:
- Добавить debounce (300-500мс) для сохранения изменений в полях (название, цена, описание)
- Сохранять изменения локально мгновенно, а на сервер отправлять с задержкой
- Показывать индикатор "сохранение..." при pending-запросах

Результат: меньше сетевых запросов, плавнее UI.

### Этап 5: Разделение AdminPanel на модули
Уменьшить связность кода для лучшей производительности.

Что будет сделано:
- Вынести секцию "Ассортимент" в отдельный компонент `ProductsSection`
- Изолировать состояние фильтров и выбранных товаров внутри этого компонента
- Уменьшить количество re-render'ов от изменений в других секциях

Результат: изменения в других частях админки не будут влиять на производительность ассортимента.

---

## Технические детали

### Виртуализация (Этап 1)
```text
┌────────────────────────────────────────────────────────────┐
│  Toolbar (фильтры, кнопки)                                 │
├────────────────────────────────────────────────────────────┤
│  Заголовок таблицы (sticky)                                │
├────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Виртуальный скролл-контейнер                        │  │
│  │  ┌────────────────────────────────────────────────┐  │  │
│  │  │  Строка товара 1 (видима)                      │  │  │
│  │  │  Строка товара 2 (видима)                      │  │  │
│  │  │  ...                                           │  │  │
│  │  │  Строка товара N (видима)                      │  │  │
│  │  └────────────────────────────────────────────────┘  │  │
│  │           (остальные 580 строк не рендерятся)        │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────┘
```

### Зависимости
- Добавить: `@tanstack/react-virtual` (легковесная библиотека виртуализации)

### Файлы для изменения
1. `src/pages/AdminPanel.tsx` — основные изменения
2. `src/components/admin/ProductsSection.tsx` — новый компонент (этап 5)
3. `src/components/admin/VirtualProductTable.tsx` — новый компонент для виртуализированной таблицы
4. `src/components/admin/MemoizedProductRow.tsx` — мемоизированная строка
5. `src/components/admin/ImageGalleryViewer.tsx` — оптимистичные превью
6. `src/components/admin/InlineEditableCell.tsx` — debounce

### Ожидаемый результат
- Первоначальная загрузка: **в 10-20 раз быстрее**
- Добавление товара: **мгновенно** (виртуальный список автоматически показывает новый элемент)
- Добавление фото: **мгновенный превью**, загрузка в фоне
- Скролл по 600+ товарам: **плавный 60 FPS**

### Порядок реализации
Предлагаю начать с Этапа 1 (виртуализация), так как это даст наибольший прирост производительности. Остальные этапы можно реализовать параллельно или последовательно для дополнительных улучшений.
