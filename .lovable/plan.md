
# План оптимизации производительности ассортимента (300+ товаров)

## Статус: ЗАВЕРШЕНО ✅

## Проблема
Когда в ассортименте более 300 товаров, страница начинает тормозить при:
- Добавлении нового товара
- Добавлении/редактировании фото
- Любых изменениях в таблице

## Решение: 5-этапная оптимизация

### ✅ Этап 1: Виртуализация таблицы товаров (ВЫПОЛНЕНО)
Создан компонент `VirtualProductTable.tsx` с использованием `@tanstack/react-virtual`:
- Рендерятся только видимые строки (~20-30 вместо 600+)
- Высота строк динамически изменяется для раскрытых изображений
- Overscan буфер для плавного скролла

**Файлы:**
- `src/components/admin/VirtualProductTable.tsx` - виртуализированная таблица
- `src/components/admin/ProductsSection.tsx` - изолированная секция ассортимента

### ✅ Этап 2: Мемоизация строк таблицы (ВЫПОЛНЕНО)
Создан `MemoizedProductRow.tsx` с `React.memo` и кастомной функцией сравнения:
- Строки перерисовываются только при изменении своих данных
- Все callback-функции стабилизированы через `useCallback`
- Глубокое сравнение для Set и массивов

**Файлы:**
- `src/components/admin/MemoizedProductRow.tsx` - мемоизированная строка

### ✅ Этап 3: Оптимизация загрузки изображений (ВЫПОЛНЕНО)
Добавлены оптимистичные превью:
- Локальные blob URL показываются мгновенно через `URL.createObjectURL`
- Загрузка в фоне с прогрессом
- Автоматическая очистка blob URL после загрузки

**Файлы:**
- `src/hooks/useOptimisticImagePreviews.ts` - хук для управления превью

### ✅ Этап 4: Debounce для инлайн-редактирования (ВЫПОЛНЕНО)
Обновлен `InlineEditableCell.tsx`:
- Добавлен debounce 500мс для сохранения
- Оптимистичное обновление UI
- Очистка таймеров при unmount

**Файлы:**
- `src/components/admin/InlineEditableCell.tsx` - debounced сохранение

### ✅ Этап 5: Интеграция в AdminPanel (ВЫПОЛНЕНО)
Заменена старая таблица товаров на `ProductsSection`:
- Передаются все необходимые props
- Удалён дублирующийся код из AdminPanel (~650 строк)
- Полная совместимость с существующей логикой

**Файлы:**
- `src/pages/AdminPanel.tsx` - интеграция ProductsSection

---

## Новые компоненты (созданы)

1. **VirtualProductTable** - виртуализированная таблица товаров
2. **MemoizedProductRow** - мемоизированная строка с React.memo
3. **ProductsSection** - изолированная секция с локальным стейтом
4. **useOptimisticImagePreviews** - хук для мгновенных превью

## Ожидаемый результат
- Первоначальная загрузка: **в 10-20 раз быстрее**
- Добавление товара: **мгновенно**
- Добавление фото: **мгновенный превью**, загрузка в фоне
- Скролл по 600+ товарам: **плавный 60 FPS**

---

## Технические детали

### Виртуализация (Этап 1)
```text
┌────────────────────────────────────────────────────────────┐
│  Toolbar (фильтры, кнопки)                                 │
├────────────────────────────────────────────────────────────┤
│  Заголовок таблицы (sticky)                                │
├────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Виртуальный скролл-контейнер                        │  │
│  │  ┌────────────────────────────────────────────────┐  │  │
│  │  │  Строка товара 1 (видима)                      │  │  │
│  │  │  Строка товара 2 (видима)                      │  │  │
│  │  │  ...                                           │  │  │
│  │  │  Строка товара N (видима)                      │  │  │
│  │  └────────────────────────────────────────────────┘  │  │
│  │           (остальные 580 строк не рендерятся)        │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────┘
```

### Зависимости
- Добавить: `@tanstack/react-virtual` (легковесная библиотека виртуализации)

### Файлы для изменения
1. `src/pages/AdminPanel.tsx` — основные изменения
2. `src/components/admin/ProductsSection.tsx` — новый компонент (этап 5)
3. `src/components/admin/VirtualProductTable.tsx` — новый компонент для виртуализированной таблицы
4. `src/components/admin/MemoizedProductRow.tsx` — мемоизированная строка
5. `src/components/admin/ImageGalleryViewer.tsx` — оптимистичные превью
6. `src/components/admin/InlineEditableCell.tsx` — debounce

### Ожидаемый результат
- Первоначальная загрузка: **в 10-20 раз быстрее**
- Добавление товара: **мгновенно** (виртуальный список автоматически показывает новый элемент)
- Добавление фото: **мгновенный превью**, загрузка в фоне
- Скролл по 600+ товарам: **плавный 60 FPS**

### Порядок реализации
Предлагаю начать с Этапа 1 (виртуализация), так как это даст наибольший прирост производительности. Остальные этапы можно реализовать параллельно или последовательно для дополнительных улучшений.
