
# ะะปะฐะฝ: ะะตัะฐััะธั ะบะฐัะตะณะพัะธะน ั ะฟะตัะตัะฐัะบะธะฒะฐะฝะธะตะผ (parent-subcategory)

## ะฆะตะปั

ะะพะทะฒะพะปะธัั ะฟัะพะดะฐะฒัั ะพัะณะฐะฝะธะทะพะฒัะฒะฐัั ะบะฐัะตะณะพัะธะธ ะฒ ะธะตัะฐััะธั (ะณะปะฐะฒะฝะฐั ะบะฐัะตะณะพัะธั โ ะฟะพะดะบะฐัะตะณะพัะธะธ) ะผะตัะพะดะพะผ ะฟะตัะตัะฐัะบะธะฒะฐะฝะธั ะฒ ะดะธะฐะปะพะณะต "ะะพััะดะพะบ ะบะฐัะตะณะพัะธะน". ะะพะบัะฟะฐัะตะปะธ ะฑัะดัั ะฒะธะดะตัั ััั ะธะตัะฐััะธั ะฝะฐ ะฒะธััะธะฝะต.

## ะงัะพ ัะฒะธะดะธั ะฟัะพะดะฐะฒะตั

```text
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ะะพััะดะพะบ ะบะฐัะตะณะพัะธะน: ะะฟัะพะฒัะน ะฟัะฐะนั                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                             โ
โ  โฎโฎ ๐ง ะกััั                        [ะกะดะตะปะฐัั ะณะปะฐะฒะฝะพะน]       โ
โ      โโโ โฎโฎ ะะพััะธะพะฝะฝัะน ััั                                 โ
โ      โโโ โฎโฎ ะะบััะพะฒัะต ัััั ั ะดะพะฑะฐะฒะบะฐะผะธ                      โ
โ      โโโ โฎโฎ ะกะผะตัะฐะฝะฝะพะต ะผะพะปะพะบะพ                               โ
โ                                                             โ
โ  โฎโฎ ๐ฅ ะะตะปะธะบะฐัะตัั                  [ะกะดะตะปะฐัั ะณะปะฐะฒะฝะพะน]       โ
โ      โโโ โฎโฎ ะคััั 2                                         โ
โ      โโโ โฎโฎ ะะพัััะธะต ะดะตะปะธะบะฐัะตัั                             โ
โ                                                             โ
โ  โฎโฎ ๐ท๏ธ ะัะตะฝะดั                      [ะกะดะตะปะฐัั ะณะปะฐะฒะฝะพะน]       โ
โ      โโโ โฎโฎ ะัะตะฝะด ะะพะตัะฝ ััะพัั                              โ
โ      โโโ โฎโฎ ะัะตะฝะด ะกัั ะะฐะฝะดะฐะฝะฐ                              โ
โ                                                             โ
โ                          [ะัะผะตะฝะฐ]  [ะกะพััะฐะฝะธัั]              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ะะตัะฐะฝะธะบะฐ drag-and-drop:**
- ะะตัะตัะฐัะธัั ะบะฐัะตะณะพัะธั ะะ ะดััะณัั โ ะพะฝะฐ ััะฐะฝะพะฒะธััั ะฟะพะดะบะฐัะตะณะพัะธะตะน
- ะะตัะตัะฐัะธัั ะฟะพะดะบะฐัะตะณะพัะธั ะะะะะฃ ะณะปะฐะฒะฝัะผะธ โ ะพะฝะฐ ััะฐะฝะพะฒะธััั ะณะปะฐะฒะฝะพะน
- ะะตัะตัะฐัะธัั ะฟะพะดะบะฐัะตะณะพัะธั ะฒะฝัััะธ ัะพะดะธัะตะปั โ ะผะตะฝัะตััั ะฟะพััะดะพะบ
- ะะฝะพะฟะบะฐ "ะกะดะตะปะฐัั ะณะปะฐะฒะฝะพะน" ัะฑะธัะฐะตั ะบะฐัะตะณะพัะธั ะธะท ัะพะดะธัะตะปั

## ะงัะพ ัะฒะธะดะธั ะฟะพะบัะฟะฐัะตะปั

ะะฐ ะฒะธััะธะฝะต (GuestCatalogView, StoreFront, RetailStore):

```text
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ โผ ะะฐัะตะณะพัะธะธ             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ   ะัะต ะบะฐัะตะณะพัะธะธ         โ
โ โถ ะกััั                  โ  โ ะะปะฐะฒะฝะฐั (ะถะธัะฝัะน ััะธัั)
โ     ะะพััะธะพะฝะฝัะน ััั      โ  โ ะะพะดะบะฐัะตะณะพัะธั (ั ะพััััะฟะพะผ)
โ     ะะบััะพะฒัะต ัััั       โ
โ     ะกะผะตัะฐะฝะฝะพะต ะผะพะปะพะบะพ    โ
โ โถ ะะตะปะธะบะฐัะตัั            โ
โ     ะคััั 2              โ
โ     ะะพัััะธะต ะดะตะปะธะบะฐัะตัั  โ
โ โถ ะัะตะฝะดั                โ
โ     ะัะตะฝะด ะะพะตัะฝ ััะพัั   โ
โ     ะัะตะฝะด ะกัั ะะฐะฝะดะฐะฝะฐ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

ะัะธ ะฒัะฑะพัะต ะณะปะฐะฒะฝะพะน ะบะฐัะตะณะพัะธะธ - ะฟะพะบะฐะทัะฒะฐัััั ะฒัะต ัะพะฒะฐัั ะธะท ะฝะตั ะธ ะฟะพะดะบะฐัะตะณะพัะธะน.

---

## ะขะตัะฝะธัะตัะบะธะต ะธะทะผะตะฝะตะฝะธั

### 1. ะะฐะทะฐ ะดะฐะฝะฝัั

**ะะพะฑะฐะฒะธัั ะฟะพะปะต `parent_category_id` ะฒ `catalog_category_settings`:**

```sql
ALTER TABLE catalog_category_settings 
ADD COLUMN parent_category_id UUID REFERENCES categories(id) ON DELETE SET NULL;
```

ะญัะพ ะฟะพะทะฒะพะปะธั ะทะฐะดะฐะฒะฐัั ะธะตัะฐััะธั ะพัะดะตะปัะฝะพ ะดะปั ะบะฐะถะดะพะณะพ ะฟัะฐะนั-ะปะธััะฐ (ะบะฐัะฐะปะพะณะฐ).

**ะะฑะฝะพะฒะธัั RPC `get_catalog_categories_ordered`:**

```sql
CREATE OR REPLACE FUNCTION get_catalog_categories_ordered(
  _catalog_id UUID,
  _store_id UUID
)
RETURNS TABLE (
  id UUID,
  name TEXT,
  slug TEXT,
  parent_id UUID,           -- ะะปะพะฑะฐะปัะฝัะน parent_id (fallback)
  catalog_parent_id UUID,   -- ะะฐัะฐะปะพะณ-ัะฟะตัะธัะธัะฝัะน parent (ะฟัะธะพัะธัะตั)
  sort_order INT,
  image_url TEXT
) AS $$
SELECT 
  c.id,
  COALESCE(ccs.custom_name, c.name) as name,
  c.slug,
  c.parent_id,
  ccs.parent_category_id as catalog_parent_id,
  COALESCE(ccs.sort_order, c.sort_order, 999999) as sort_order,
  c.image_url
FROM categories c
LEFT JOIN catalog_category_settings ccs 
  ON ccs.category_id = c.id 
  AND ccs.catalog_id = _catalog_id
WHERE c.store_id = _store_id
ORDER BY sort_order;
$$ LANGUAGE SQL STABLE;
```

### 2. ะะฑะฝะพะฒะธัั CategoryOrderDialog

| ะคะฐะนะป | ะะทะผะตะฝะตะฝะธั |
|------|-----------|
| `src/components/admin/CategoryOrderDialog.tsx` | ะะพะฑะฐะฒะธัั ะฒะปะพะถะตะฝะฝัะน drag-and-drop ั ะฟะพะดะดะตัะถะบะพะน ะธะตัะฐััะธะธ |

**ะัะฝะพะฒะฝัะต ะธะทะผะตะฝะตะฝะธั:**
- ะัะฟะพะปัะทะพะฒะฐัั `@dnd-kit/sortable` ั ะฟะพะดะดะตัะถะบะพะน ะฒะปะพะถะตะฝะฝัั ะบะพะฝัะตะนะฝะตัะพะฒ
- ะะพะฑะฐะฒะธัั ัะพััะพัะฝะธะต `hierarchyMap: Map<string | null, string[]>` ะดะปั ะพััะปะตะถะธะฒะฐะฝะธั parent โ children
- ะัะธ ะฟะตัะตัะฐัะบะธะฒะฐะฝะธะธ ะพะฟัะตะดะตะปััั:
  - Drop ะฝะฐ ัะปะตะผะตะฝั โ ัะดะตะปะฐัั child
  - Drop ะผะตะถะดั ัะปะตะผะตะฝัะฐะผะธ โ ัะดะตะปะฐัั sibling
- ะะพะฑะฐะฒะธัั ะบะฝะพะฟะบั "ะกะดะตะปะฐัั ะณะปะฐะฒะฝะพะน" (ะธะปะธ ะธะบะพะฝะบั) ะดะปั ะฑััััะพะณะพ ะพัะบัะตะฟะปะตะฝะธั ะพั ัะพะดะธัะตะปั

**ะกัััะบัััะฐ ะดะฐะฝะฝัั ะดะปั ัะพััะฐะฝะตะฝะธั:**

```typescript
interface CategoryHierarchyItem {
  id: string;
  parent_id: string | null;  // null = ะณะปะฐะฒะฝะฐั ะบะฐัะตะณะพัะธั
  sort_order: number;
}

// onSave ัะตะฟะตัั ะฟัะธะฝะธะผะฐะตั ะฟะพะปะฝัั ะธะตัะฐััะธั
onSave: (items: CategoryHierarchyItem[]) => Promise<void>
```

### 3. ะะฑะฝะพะฒะธัั useStoreCategories

| ะคะฐะนะป | ะะทะผะตะฝะตะฝะธั |
|------|-----------|
| `src/hooks/useStoreCategories.ts` | ะะฑะฝะพะฒะธัั `updateCatalogCategoryOrder` ะดะปั ัะพััะฐะฝะตะฝะธั ะธะตัะฐััะธะธ |

```typescript
const updateCatalogCategoryHierarchy = useCallback(async (
  catalogId: string, 
  items: { id: string; parent_id: string | null; sort_order: number }[]
) => {
  const upserts = items.map((item) => 
    supabase
      .from('catalog_category_settings')
      .upsert({
        catalog_id: catalogId,
        category_id: item.id,
        parent_category_id: item.parent_id,  // ะะฐัะฐะปะพะณ-ัะฟะตัะธัะธัะฝัะน parent
        sort_order: item.sort_order,
        updated_at: new Date().toISOString()
      }, { 
        onConflict: 'catalog_id,category_id'
      })
  );
  
  await Promise.all(upserts);
}, []);
```

### 4. ะะฑะฝะพะฒะธัั ะฒะธััะธะฝั (ะฟะพะบัะฟะฐัะตะปััะบะธะน ะฒะธะด)

| ะคะฐะนะป | ะะทะผะตะฝะตะฝะธั |
|------|-----------|
| `src/pages/GuestCatalogView.tsx` | ะะตะฝะดะตัะธัั ะธะตัะฐััะธั ั ะพััััะฟะฐะผะธ ะฒ dropdown |
| `src/pages/StoreFront.tsx` | ะขะพ ะถะต ัะฐะผะพะต |
| `src/pages/CustomerDashboard.tsx` | ะขะพ ะถะต ัะฐะผะพะต |
| `src/components/retail/RetailLayoutSidebar.tsx` | ะะตะฝะดะตัะธัั ะดะตัะตะฒะพ ะบะฐัะตะณะพัะธะน |
| `src/components/wholesale/WholesaleCategorySelector.tsx` | ะะพะฑะฐะฒะธัั ะฒะธะทัะฐะปัะฝัั ะธะตัะฐััะธั |

**ะะพะณะธะบะฐ ะฟะพัััะพะตะฝะธั ะดะตัะตะฒะฐ:**

```typescript
// ะัะธะพัะธัะตั: catalog_parent_id > parent_id > null
function buildCategoryTree(categories: CategoryWithHierarchy[]) {
  const roots: CategoryNode[] = [];
  const childrenMap = new Map<string, CategoryNode[]>();
  
  categories.forEach(cat => {
    const parentId = cat.catalog_parent_id ?? cat.parent_id;
    if (!parentId) {
      roots.push({ ...cat, children: [] });
    } else {
      const siblings = childrenMap.get(parentId) || [];
      siblings.push({ ...cat, children: [] });
      childrenMap.set(parentId, siblings);
    }
  });
  
  // ะัะธัะพะตะดะธะฝะธัั ะดะตัะตะน ะบ ัะพะดะธัะตะปัะผ
  roots.forEach(root => {
    root.children = childrenMap.get(root.id) || [];
  });
  
  return roots;
}
```

**ะะตะฝะดะตัะธะฝะณ ะฒ dropdown ั ะพััััะฟะฐะผะธ:**

```tsx
{categoryTree.map(parent => (
  <>
    <DropdownMenuItem className="font-semibold">
      {parent.name}
    </DropdownMenuItem>
    {parent.children.map(child => (
      <DropdownMenuItem className="pl-6">
        {child.name}
      </DropdownMenuItem>
    ))}
  </>
))}
```

---

## ะะพะณะธะบะฐ ะฟัะธะฒัะทะบะธ ัะพะฒะฐัะพะฒ

**ะขะตะบััะตะต ะฟะพะฒะตะดะตะฝะธะต:**
- ะขะพะฒะฐั ะฟัะธะฒัะทัะฒะฐะตััั ะบ `primary_category_id` + ะผะฐััะธะฒั `categories` ะฒ `catalog_product_settings`

**ะะพัะปะต ะธะทะผะตะฝะตะฝะธะน:**
- ะัะปะธ ัะพะฒะฐั ะฟัะธะฒัะทะฐะฝ ะบ ะฟะพะดะบะฐัะตะณะพัะธะธ - ะฟัะธ ะฒัะฑะพัะต ัะพะดะธัะตะปััะบะพะน ะบะฐัะตะณะพัะธะธ ะฝะฐ ะฒะธััะธะฝะต ัะพะฒะฐั ัะพะถะต ะพัะพะฑัะฐะถะฐะตััั
- ะัะปะธ ะฒัะฑัะฐะฝะฐ ะฟะพะดะบะฐัะตะณะพัะธั - ะฟะพะบะฐะทัะฒะฐัััั ัะพะปัะบะพ ัะพะฒะฐัั ััะพะน ะฟะพะดะบะฐัะตะณะพัะธะธ

```typescript
// ะคะธะปัััะฐัะธั ัะพะฒะฐัะพะฒ ะฟัะธ ะฒัะฑะพัะต ะบะฐัะตะณะพัะธะธ
function getProductsForCategory(categoryId: string, allCategories: CategoryNode[]) {
  // ะะฐะนัะธ ะฒัะต ะดะพัะตัะฝะธะต ะบะฐัะตะณะพัะธะธ
  const categoryIds = new Set<string>([categoryId]);
  
  function addChildren(parentId: string) {
    const parent = allCategories.find(c => c.id === parentId);
    parent?.children?.forEach(child => {
      categoryIds.add(child.id);
      addChildren(child.id);
    });
  }
  
  addChildren(categoryId);
  
  // ะคะธะปัััะพะฒะฐัั ัะพะฒะฐัั ะฟะพ ะปัะฑะพะน ะธะท ะบะฐัะตะณะพัะธะน
  return products.filter(p => 
    p.catalog_categories?.some(catId => categoryIds.has(catId))
  );
}
```

---

## ะะพััะดะพะบ ัะตะฐะปะธะทะฐัะธะธ

1. **ะะธะณัะฐัะธั ะะ** โ ะดะพะฑะฐะฒะธัั `parent_category_id` ะฒ `catalog_category_settings`
2. **ะะฑะฝะพะฒะธัั RPC** โ ะฒะพะทะฒัะฐัะฐัั ะบะฐัะฐะปะพะณ-ัะฟะตัะธัะธัะฝัะน parent
3. **CategoryOrderDialog** โ ะดะพะฑะฐะฒะธัั ะฒะปะพะถะตะฝะฝัะน drag-and-drop
4. **useStoreCategories** โ ะพะฑะฝะพะฒะธัั ััะฝะบัะธั ัะพััะฐะฝะตะฝะธั ะธะตัะฐััะธะธ
5. **ะะธััะธะฝั** โ ัะตะฝะดะตัะธัั ะธะตัะฐััะธั ั ะพััััะฟะฐะผะธ ะธ ัะธะปัััะฐัะธะตะน

---

## ะะธะทัะฐะปัะฝะฐั ะดะตะผะพะฝัััะฐัะธั ะผะตัะฐะฝะธะบะธ drag-and-drop

```text
ะะะะะขะะกะะะะะะะ:

1. ะะตัะตัะฐัะธัั "ะะพััะธะพะฝะฝัะน ััั" ะะ "ะกััั":
   
   ะะพ:                          ะะพัะปะต:
   โฎโฎ ะะพััะธะพะฝะฝัะน ััั            โฎโฎ ะกััั
   โฎโฎ ะกััั                         โโโ โฎโฎ ะะพััะธะพะฝะฝัะน ััั

2. ะะตัะตัะฐัะธัั ะฟะพะดะบะฐัะตะณะพัะธั ะะซะจะ ะณะปะฐะฒะฝัั:

   ะะพ:                          ะะพัะปะต:
   โฎโฎ ะกััั                      โฎโฎ ะะพััะธะพะฝะฝัะน ััั  โ ััะฐะปะฐ ะณะปะฐะฒะฝะพะน
      โโโ โฎโฎ ะะพััะธะพะฝะฝัะน ััั     โฎโฎ ะกััั

3. ะะตะฝััั ะฟะพััะดะพะบ ะฒะฝัััะธ ัะพะดะธัะตะปั:

   ะะพ:                          ะะพัะปะต:
   โฎโฎ ะกััั                      โฎโฎ ะกััั
      โโโ โฎโฎ ะะพััะธะพะฝะฝัะน          โโโ โฎโฎ ะะบััะพะฒัะต
      โโโ โฎโฎ ะะบััะพะฒัะต            โโโ โฎโฎ ะะพััะธะพะฝะฝัะน
```
