
# Восстановление старых фото и исправление логики импорта

## Проблема

При импорте фото из Excel код **заменял** массив `images` на новые фото вместо того, чтобы **добавлять** новые к существующим. Строка 709 в `priceListImport.ts`:

```typescript
// Было (заменяет):
images: uploadedUrls

// Нужно (добавляет новые первыми):
images: [...uploadedUrls, ...existingProduct.images]
```

## План действий

### 1. Восстановить старые фото (edge function)

Создать edge function `restore-product-images`, которая:
- Для каждого затронутого товара (store_id = `25a0ac3f-...`, обновлён за последние 2 часа, 1 фото в массиве)
- Сканирует папку товара в storage `product-images/{productId}/`
- Находит ВСЕ файлы (старые + новые)
- Ставит новое фото (с timestamp `1770407xxx`) первым (как главное)
- Старые фото добавляет после него
- Обновляет поле `images` в БД

### 2. Исправить импорт (priceListImport.ts)

В двух местах (строки 707-711 и 795-799) изменить логику:

**Для существующих товаров (строка ~707):**
```typescript
if (uploadedUrls.length > 0) {
  // Сохранить существующие фото и добавить новые как главные
  const existingImages = existingProduct.images || [];
  const mergedImages = [...uploadedUrls, ...existingImages];
  await supabase.from('products').update({
    images: mergedImages
  }).eq('id', existingProduct.id);
}
```

**Для новых товаров (строка ~795):** оставить как есть (у новых нет старых фото).

### 3. Запустить восстановление

После деплоя edge function вызвать её один раз для восстановления всех 529 затронутых товаров.

---

## Файлы для изменения

| Файл | Что меняется |
|------|-------------|
| `supabase/functions/restore-product-images/index.ts` | Новый файл -- сканирует storage и восстанавливает фото |
| `src/lib/priceListImport.ts` | Строки 707-711: merge вместо replace при загрузке фото |

## Результат

- Все старые фото возвращены в карточки товаров
- Новые фото из Excel стоят первыми (как главные)
- В будущем импорт фото не будет затирать существующие
