
# План: Подключение кастомного домена для оптового магазина

## Текущая проблема

Домен `opt9.ru` настроен корректно (A-запись → 185.158.133.1), но:

1. В приложении нет обработки кастомных доменов для **оптовых** магазинов
2. Существующий `useStoreResolver` и `useStoreByCustomDomain` работают только для **розничных** магазинов (ищут по `custom_domain`)
3. Для wholesale нужно искать по полю `wholesale_custom_domain`

---

## Часть 1: Добавить хук для wholesale кастомных доменов

### Новый хук `useWholesaleByCustomDomain`

В файле `src/hooks/useWholesaleStore.ts` добавить:

```typescript
export function useWholesaleByCustomDomain(domain: string | null) {
  // Поиск магазина по wholesale_custom_domain
  // Если найден → вернуть store, subdomain
}
```

---

## Часть 2: Универсальный резолвер доменов

### Обновить `useStoreResolver` в `useRetailStore.ts`

Добавить поддержку определения типа магазина:

```typescript
export function useStoreResolver() {
  // Проверить: это платформенный домен или кастомный?
  // Если кастомный → проверить в БД:
  //   1. Сначала по wholesale_custom_domain
  //   2. Затем по custom_domain (retail)
  // Вернуть { type, subdomain, storeType: 'retail' | 'wholesale' }
}
```

---

## Часть 3: Обработчик кастомных доменов в App.tsx

### Новый компонент `CustomDomainHandler`

Определяет, какой магазин открывать по кастомному домену:

```text
1. Получить hostname (например, opt9.ru)
2. Проверить: это platform domain?
   - Да → показать обычный роутинг
   - Нет → искать магазин по кастомному домену
3. Если найден магазин:
   - wholesale_custom_domain совпадает → показать WholesaleStore
   - custom_domain совпадает → показать RetailStore
4. Если не найден → показать ошибку "Магазин не найден"
```

---

## Часть 4: Обновить инструкции DNS в админке

### Файл: `WholesaleSettingsSection.tsx`

Добавить более подробную инструкцию:

```text
┌────────────────────────────────────────────────────────────┐
│ 🔧 Настройка DNS                                            │
├────────────────────────────────────────────────────────────┤
│                                                            │
│ Добавьте следующие записи у вашего регистратора домена:   │
│                                                            │
│ ┌──────────────────────────────────────────────────────┐   │
│ │ Тип: A                                                │   │
│ │ Имя: @ (корневой домен)                               │   │
│ │ Значение: 185.158.133.1                               │   │
│ └──────────────────────────────────────────────────────┘   │
│                                                            │
│ ┌──────────────────────────────────────────────────────┐   │
│ │ Тип: A                                                │   │
│ │ Имя: www                                              │   │
│ │ Значение: 185.158.133.1                               │   │
│ └──────────────────────────────────────────────────────┘   │
│                                                            │
│ ⏱ Изменения DNS могут занять до 48 часов                  │
│                                                            │
│ ℹ️ TXT-запись _lovable НЕ требуется для кастомных         │
│   доменов магазинов — она нужна только для подключения    │
│   домена к проекту Lovable через Settings → Domains       │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

---

## Часть 5: Аналогично для RetailSettingsSection.tsx

Добавить такие же подробные инструкции для розничных доменов.

---

## Технические детали

### Файлы для изменения

| Файл | Действие |
|------|----------|
| `src/hooks/useWholesaleStore.ts` | Добавить `useWholesaleByCustomDomain` |
| `src/hooks/useRetailStore.ts` | Расширить `useStoreResolver` для wholesale |
| `src/App.tsx` | Добавить `CustomDomainHandler` для роутинга по кастомным доменам |
| `src/components/admin/WholesaleSettingsSection.tsx` | Улучшить инструкции DNS |
| `src/components/admin/RetailSettingsSection.tsx` | Улучшить инструкции DNS |

### Логика резолвинга домена

```text
Запрос на opt9.ru
        ↓
  isPlatformDomain?
        ↓
       Нет
        ↓
  Поиск в stores по wholesale_custom_domain = 'opt9.ru'
        ↓
    Найден?
        ↓
       Да → Рендер WholesaleStore с subdomain магазина
```

---

## Ожидаемый результат

После реализации:
1. Домен `opt9.ru` будет открывать оптовый магазин напрямую
2. Не требуется TXT-запись `_lovable` — она нужна только для project-level доменов
3. Инструкции в админке будут чётко объяснять, какие DNS-записи нужны
